<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Niko AI - Admin Panel</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Admin Paneli Global Tema G√ºncellemesi (Mor -> Cyan/Teal) */
      :root {
        --accent-primary: #06b6d4;
        --accent-primary-hover: #22d3ee;
        --accent-secondary: #2dd4bf;
        --accent-glow: rgba(6, 182, 212, 0.3);
        --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #2dd4bf 100%);
        --border-focus: rgba(6, 182, 212, 0.5);
        --shadow-glow: 0 0 40px rgba(6, 182, 212, 0.15);
      }

      /* Admin Paneli √ñzel Stilleri */
      .admin-container {
        min-height: 100vh;
        padding: var(--spacing-lg);
      }

      .admin-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 48px;
        padding: 32px 40px;
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .admin-title {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .admin-title h1 {
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        background: linear-gradient(135deg, #fff 0%, #06b6d4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .admin-actions {
        display: flex;
        gap: 16px;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 16px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s var(--transition-premium);
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .btn-primary {
        background: var(--accent-gradient);
        border: none;
        color: white;
        box-shadow: 0 8px 20px rgba(6, 182, 212, 0.2);
      }

      .btn-primary:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 12px 25px rgba(6, 182, 212, 0.3);
        filter: brightness(1.1);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.7);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(6, 182, 212, 0.3);
        color: white;
        transform: translateY(-2px);
      }

      /* Tablo Kontrolleri */
      .table-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 24px;
        padding: 0 10px;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .filter-group label {
        font-size: 0.8rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .filter-group select {
        padding: 10px 16px;
        background: rgba(15, 15, 25, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-group select:hover {
        border-color: rgba(6, 182, 212, 0.5);
        background: rgba(15, 15, 25, 0.8);
      }

      /* Kullanƒ±cƒ±lar Tablosu */
      .users-table-container {
        background: rgba(255, 255, 255, 0.01);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 32px;
        overflow: hidden;
        padding: 24px;
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.2);
      }

      .users-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 12px;
      }

      .users-table th {
        padding: 20px 24px;
        text-align: left;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(6, 182, 212, 0.7);
        font-weight: 800;
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .users-table td {
        padding: 20px 24px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.4s var(--transition-premium);
        font-size: 0.95rem;
        font-weight: 500;
      }

      .users-table tbody tr:hover td {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(6, 182, 212, 0.2);
        color: #fff;
        transform: scale(1.005);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .users-table tr td:first-child {
        border-radius: 20px 0 0 20px;
      }

      .users-table tr td:last-child {
        border-radius: 0 20px 20px 0;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge-admin {
        background: rgba(6, 182, 212, 0.15);
        color: #22d3ee;
        border: 1px solid rgba(6, 182, 212, 0.2);
      }

      .badge-user {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .action-buttons {
        display: flex;
        gap: 12px;
      }

      /* Bo≈ü Durum */
      .empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
      }

      .empty-state-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
      }

      /* Modal & Overlay */
      .admin-modal.modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }

      .admin-modal.modal-overlay.active {
        display: flex;
      }

      @media (max-width: 768px) {
        .admin-modal.modal-overlay {
          align-items: flex-start;
          padding: 40px 10px;
        }
      }

      /* Y√ºkleniyor Durumu */
      .loading-state {
        text-align: center;
        padding: var(--spacing-lg);
        color: var(--text-secondary);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-primary);
        border-top-color: #06b6d4;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto var(--spacing-md);
      }

      /* Modal & Form - Avant-Garde Premium Redesign */
      .admin-modal .modal {
        width: 90%;
        max-width: 520px;
        max-height: 90vh;
        overflow-y: auto;
        background: linear-gradient(
          165deg,
          rgba(15, 15, 25, 0.8) 0%,
          rgba(5, 5, 10, 0.9) 100%
        );
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 40px;
        padding: 48px;
        box-shadow: 
          0 40px 100px rgba(0, 0, 0, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.02);
        animation: modalSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
      }

      /* Custom Scrollbar for Modal */
      .admin-modal .modal::-webkit-scrollbar {
        width: 6px;
      }
      .admin-modal .modal::-webkit-scrollbar-track {
        background: transparent;
      }
      .admin-modal .modal::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }

      .admin-modal .modal::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle at center,
          rgba(6, 182, 212, 0.03) 0%,
          transparent 50%
        );
        pointer-events: none;
        z-index: -1;
      }

      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-title {
        font-size: 2.25rem;
        font-weight: 800;
        letter-spacing: -0.04em;
        margin-bottom: 32px;
        background: linear-gradient(135deg, #fff 30%, rgba(255, 255, 255, 0.4) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.1));
      }

      .admin-modal .form-group {
        margin-bottom: 28px;
        position: relative;
      }

      .admin-modal label {
        font-size: 0.75rem;
        font-weight: 800;
        color: rgba(6, 182, 212, 0.8);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        margin-bottom: 12px;
        display: block;
        padding-left: 4px;
        transition: all 0.3s ease;
      }

      .admin-modal input[type="text"],
      .admin-modal input[type="password"],
      .admin-modal input[type="email"] {
        width: 100%;
        padding: 18px 24px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.07);
        border-radius: 20px;
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.4s var(--transition-premium);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .admin-modal input:focus {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(6, 182, 212, 0.5);
        box-shadow: 
          0 0 0 4px rgba(6, 182, 212, 0.1),
          0 10px 20px rgba(0, 0, 0, 0.2);
        outline: none;
        transform: translateY(-2px);
      }

      .admin-modal .form-group:focus-within label {
        color: #fff;
        transform: translateX(4px);
      }

      .field-hint {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.25);
        margin-top: 10px;
        padding-left: 4px;
        font-style: italic;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 8px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 16px;
        transition: all 0.3s ease;
      }

      .checkbox-group:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .checkbox-group input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        position: relative;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .checkbox-group input[type="checkbox"]:checked {
        background: var(--accent-gradient);
        border-color: transparent;
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 5px 15px rgba(6, 182, 212, 0.4);
      }

      .checkbox-group input[type="checkbox"]:checked::after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
        font-weight: 900;
      }

      .checkbox-group label {
        font-size: 0.95rem;
        text-transform: none;
        letter-spacing: normal;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        margin-bottom: 0;
        cursor: pointer;
      }

      .admin-modal .modal-actions {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-top: 40px;
      }

      .modal-btn {
        padding: 18px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.4s var(--transition-premium);
        border: 1px solid transparent;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .modal-btn.cancel {
        background: rgba(255, 255, 255, 0.03);
        color: rgba(255, 255, 255, 0.5);
        border-color: rgba(255, 255, 255, 0.05);
      }

      .modal-btn.cancel:hover {
        background: rgba(255, 68, 68, 0.1);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.2);
        transform: translateY(-2px);
      }

      .modal-btn.confirm {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 15px 30px rgba(6, 182, 212, 0.25);
        position: relative;
        overflow: hidden;
      }

      .modal-btn.confirm::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
        transform: scale(0);
        transition: transform 0.6s ease-out;
      }

      .modal-btn.confirm:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 20px 40px rgba(6, 182, 212, 0.4);
        filter: brightness(1.15);
      }

      .modal-btn.confirm:hover::after {
        transform: scale(1);
      }

      /* Tab Sistemi - Avant-Garde Upgrade */
      .admin-tabs {
        display: inline-flex;
        gap: 12px;
        margin-bottom: 48px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        backdrop-filter: blur(20px);
      }

      .tab-btn {
        padding: 14px 32px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        border-radius: 16px;
        transition: all 0.4s var(--transition-premium);
        display: flex;
        align-items: center;
        gap: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.04);
        color: rgba(255, 255, 255, 0.8);
      }

      .tab-btn.active {
        background: var(--accent-gradient);
        color: white;
        box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        transform: translateY(-2px);
      }

      .tab-content {
        display: none;
        animation: contentFadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes contentFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .tab-content.active {
        display: block;
      }

      /* User Table Mobile Refinement */
      @media (max-width: 768px) {
        .admin-header {
          padding: 24px;
          flex-direction: column;
          gap: 24px;
          text-align: center;
        }

        .admin-title {
          flex-direction: column;
          gap: 12px;
        }

        .admin-tabs {
          width: 100%;
          overflow-x: auto;
          justify-content: flex-start;
          border-radius: 20px;
        }

        .tab-btn {
          white-space: nowrap;
          padding: 12px 24px;
        }

        .users-table thead {
          display: none;
        }

        .users-table,
        .users-table tbody,
        .users-table tr,
        .users-table td {
          display: block;
          width: 100%;
        }

        .users-table tr {
          margin-bottom: 24px;
          background: rgba(255, 255, 255, 0.02);
          border-radius: 24px;
          padding: 16px;
          border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .users-table td {
          text-align: right;
          padding: 12px 16px;
          border: none;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 0.9rem;
          background: transparent !important;
        }

        .users-table td::before {
          content: attr(data-label);
          font-weight: 800;
          color: rgba(6, 182, 212, 0.6);
          text-transform: uppercase;
          font-size: 0.7rem;
          letter-spacing: 0.1em;
        }

        .users-table td:last-child {
          justify-content: center;
          gap: 12px;
          background: rgba(255, 255, 255, 0.03) !important;
          margin-top: 12px;
          padding: 20px;
          border-radius: 16px;
        }

        .users-table td:last-child::before {
          display: none;
        }

        /* Modal Mobile Adjustments */
        .admin-modal .modal {
          padding: 24px;
          border-radius: 24px;
          width: 95%;
        }

        .modal-title {
          font-size: 1.5rem;
          margin-bottom: 24px;
        }

        .admin-modal .form-group {
          margin-bottom: 20px;
        }

        .admin-modal input[type="text"],
        .admin-modal input[type="password"],
        .admin-modal input[type="email"] {
          padding: 14px 18px;
          font-size: 0.95rem;
        }

        .checkbox-group {
          padding: 12px 14px;
          gap: 12px;
        }

        .admin-modal .modal-actions {
          grid-template-columns: 1fr;
          gap: 12px;
          margin-top: 24px;
        }

        .modal-btn {
          padding: 14px;
          font-size: 0.9rem;
        }
      }
      /* Toast Feedback */
      .toast-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .toast {
        background: var(--bg-card);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border-primary);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .toast.success {
        border-left: 4px solid var(--success);
      }
      .toast.error {
        border-left: 4px solid var(--error);
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

    </style>
  </head>
  <body>
    <div class="noise-overlay"></div>
    <div class="admin-container">
      <!-- Header -->
      <header class="admin-header">
        <div class="admin-title">
          <span style="font-size: 2rem">ü§ñ</span>
          <h1>Admin Panel</h1>
        </div>
        <div class="admin-actions">
          <button class="btn btn-primary" id="newUserBtn">
            ‚ûï Yeni Kullanƒ±cƒ±
          </button>
          <button class="btn btn-secondary" id="backToAppBtn">
            ‚Üê Ana Sayfa
          </button>
        </div>
      </header>

      <!-- Multi-Tab Navigation (Simplified: Only User Management remains) -->
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="users">
          üë• Kullanƒ±cƒ± Y√∂netimi
        </button>
      </div>

      <!-- Users Table Section -->
      <div id="usersTab" class="tab-content active">
        <!-- Table Controls -->
        <div class="table-controls">
          <div class="filter-group">
            <label for="filterAdmin">Filtre:</label>
            <select id="filterAdmin">
              <option value="">T√ºm Kullanƒ±cƒ±lar</option>
              <option value="true">Sadece Adminler</option>
              <option value="false">Sadece Normal Kullanƒ±cƒ±lar</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortBy">Sƒ±rala:</label>
            <select id="sortBy">
              <option value="username">Kullanƒ±cƒ± Adƒ±</option>
              <option value="created_at">Kayƒ±t Tarihi</option>
              <option value="is_admin">Admin Durumu</option>
            </select>
            <select id="sortOrder">
              <option value="asc">Artan</option>
              <option value="desc">Azalan</option>
            </select>
          </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="username">Kullanƒ±cƒ± Adƒ±</th>
                <th>E-posta</th>
                <th>Ad Soyad</th>
                <th>≈ûifre</th>
                <th class="sortable" data-sort="is_admin">Rol</th>
                <th class="sortable" data-sort="created_at">Kayƒ±t Tarihi</th>
                <th>ƒ∞≈ülemler</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be rendered here -->
            </tbody>
          </table>

          <!-- Loading State -->
          <div class="loading-state" id="loadingState">
            <div class="loading-spinner"></div>
            <p>Kullanƒ±cƒ±lar y√ºkleniyor...</p>
          </div>

          <!-- Empty State -->
          <div class="empty-state hidden" id="emptyState">
            <div class="empty-state-icon">üë•</div>
            <p>Hen√ºz kullanƒ±cƒ± bulunmuyor.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal-overlay admin-modal" id="userModal">
      <div class="modal">
        <h3 class="modal-title" id="userModalTitle">Yeni Kullanƒ±cƒ±</h3>
        <form id="userForm" class="auth-form" style="gap: var(--spacing-md)">
          <div class="form-group">
            <label for="formUsername">Kullanƒ±cƒ± Adƒ± *</label>
            <input
              type="text"
              id="formUsername"
              placeholder="Kullanƒ±cƒ± adƒ±"
              required
            />
            <span class="field-hint">3-30 karakter, harf ile ba≈ülamalƒ±</span>
          </div>
          <div class="form-group" id="passwordGroup">
            <label for="formPassword">≈ûifre *</label>
            <input type="password" id="formPassword" placeholder="≈ûifre" />
            <span class="field-hint"
              >En az 8 karakter, b√ºy√ºk/k√º√ß√ºk harf ve rakam</span
            >
          </div>
          <div class="form-group">
            <label for="formEmail">E-posta</label>
            <input type="email" id="formEmail" placeholder="E-posta adresi" />
          </div>
          <div class="form-group">
            <label for="formFullName">Ad Soyad</label>
            <input type="text" id="formFullName" placeholder="Ad ve soyad" />
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="formIsAdmin" />
              <label for="formIsAdmin">Admin yetkisi ver</label>
            </div>
          </div>
          <div id="formError" class="error-message" style="display: none"></div>
          <div class="modal-actions" style="margin-top: var(--spacing-md)">
            <button type="button" class="modal-btn cancel" id="cancelUserBtn">
              ƒ∞ptal
            </button>
            <button type="submit" class="modal-btn confirm" id="saveUserBtn">
              Kaydet
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay admin-modal" id="deleteModal">
      <div class="modal">
        <h3 class="modal-title">Kullanƒ±cƒ±yƒ± Sil</h3>
        <p class="modal-description" id="deleteDescription">
          Bu kullanƒ±cƒ±yƒ± silmek istediƒüinizden emin misiniz? Bu i≈ülem geri
          alƒ±namaz ve kullanƒ±cƒ±nƒ±n t√ºm sohbet ge√ßmi≈üi silinecektir.
        </p>
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelDeleteBtn">ƒ∞ptal</button>
          <button class="modal-btn confirm" id="confirmDeleteBtn">Sil</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
      // ============================================================================
      // Admin Paneli JavaScript
      // Gereksinimler: 2.3, 2.4, 3.4
      // ============================================================================

      // Durum (State)
      let users = [];
      let currentEditUser = null;
      let userToDelete = null;

      // DOM Elemanlarƒ±
      const usersTableBody = document.getElementById("usersTableBody");
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const filterAdmin = document.getElementById("filterAdmin");
      const sortBy = document.getElementById("sortBy");
      const sortOrder = document.getElementById("sortOrder");
      const userModal = document.getElementById("userModal");
      const userModalTitle = document.getElementById("userModalTitle");
      const userForm = document.getElementById("userForm");
      const deleteModal = document.getElementById("deleteModal");
      const deleteDescription = document.getElementById("deleteDescription");
      const toastContainer = document.getElementById("toastContainer");

      // Tab Switching
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(`${tab}Tab`).classList.add("active");

          if (tab === "users") fetchUsers();
        });
      });

      // ============================================================================
      // Yardƒ±mcƒ± Fonksiyonlar
      // ============================================================================

      function getToken() {
        return localStorage.getItem("token");
      }

      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("tr-TR", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch {
          return dateString;
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function getErrorMessage(error) {
        if (!error) return "Bilinmeyen bir hata";
        if (typeof error === "string") return error;

        // FastAPI doƒürulama hatalarƒ±nƒ± i≈üle (detay genellikle nesnelerden olu≈üan bir listedir)
        if (error.detail) {
          if (Array.isArray(error.detail)) {
            return error.detail
              .map((err) => {
                if (typeof err === "string") return err;
                return err.msg || JSON.stringify(err);
              })
              .join(", ");
          }
          if (typeof error.detail === "object") {
            return JSON.stringify(error.detail);
          }
          return error.detail;
        }

        if (error.error) {
          if (typeof error.error === "object")
            return JSON.stringify(error.error);
          return error.error;
        }

        if (error.message) return error.message;

        // Yedek: t√ºm hata nesnesini metne d√∂n√º≈üt√ºrmeyi dene
        try {
          const str = JSON.stringify(error);
          if (str === "{}" && error.toString) return error.toString();
          return str;
        } catch (e) {
          return "Bir hata olu≈ütu";
        }
      }

      // ============================================================================
      // API Fonksiyonlarƒ±
      // ============================================================================

      function copyToClipboard(text) {
        if (!navigator.clipboard) {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            showToast("Panoya kopyalandƒ± (Yedek y√∂ntem)", "success");
          } catch (err) {
            showToast("Kopyalama ba≈üarƒ±sƒ±z", "error");
          }
          document.body.removeChild(textArea);
          return;
        }

        navigator.clipboard.writeText(text).then(() => {
          showToast("Panoya kopyalandƒ±", "success");
        }).catch(err => {
          showToast("Kopyalama hatasƒ±", "error");
        });
      }

      async function fetchUsers() {
        const token = getToken();
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        const params = new URLSearchParams();
        if (filterAdmin.value) {
          params.append("filter_admin", filterAdmin.value);
        }
        if (sortBy.value) {
          params.append("sort_by", sortBy.value);
        }
        if (sortOrder.value) {
          params.append("sort_order", sortOrder.value);
        }
        params.append("t", Date.now());

        loadingState.classList.remove("hidden");
        emptyState.classList.add("hidden");

        try {
          const response = await fetch(
            `/api/admin/users?${params.toString()}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (response.status === 401) {
            localStorage.removeItem("token");
            window.location.href = "/login.html";
            return;
          }

          if (response.status === 403) {
            showToast("Admin yetkisi gerekli", "error");
            window.location.href = "/";
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              getErrorMessage(errorData) || "Kullanƒ±cƒ±lar y√ºklenemedi",
            );
          }

          const data = await response.json();
          console.log("Fetched users:", data);
          users = data.users || [];
          renderUsers();
        } catch (error) {
          console.error("Fetch error:", error);
          showToast(error.message, "error");
          loadingState.classList.add("hidden");
        }
      }

      async function createUser(userData) {
        const token = getToken();

        try {
          const response = await fetch("/api/admin/users", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(getErrorMessage(data));
          }

          return data;
        } catch (error) {
          throw error;
        }
      }

      async function updateUser(username, userData) {
        const token = getToken();

        try {
          const response = await fetch(
            `/api/admin/users/${encodeURIComponent(username)}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            },
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(getErrorMessage(data));
          }

          return data;
        } catch (error) {
          throw error;
        }
      }

      async function deleteUser(username) {
        const token = getToken();

        try {
          const response = await fetch(
            `/api/admin/users/${encodeURIComponent(username)}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(getErrorMessage(data));
          }

          return data;
        } catch (error) {
          throw error;
        }
      }

      // ============================================================================
      // Render Fonksiyonlarƒ±
      // ============================================================================

      function renderUsers() {
        loadingState.classList.add("hidden");

        if (users.length === 0) {
          usersTableBody.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        usersTableBody.innerHTML = users
          .map(
            (user) => `
                <tr>
                    <td data-label="KULLANICI"><strong>${escapeHtml(user.username)}</strong></td>
                    <td data-label="E-POSTA">${escapeHtml(user.email) || '<span style="color: var(--text-muted);">-</span>'}</td>
                    <td data-label="AD SOYAD">${escapeHtml(user.full_name) || '<span style="color: var(--text-muted);">-</span>'}</td>
                    <td data-label="≈ûƒ∞FRE">
                        <code style="background: var(--bg-tertiary); padding: 2px 4px; border-radius: 4px; font-size: 0.8rem;">
                            ${escapeHtml(user.plain_password || user._plain_password) || "***"}
                        </code>
                    </td>
                    <td data-label="ROL">
                        <span class="badge ${user.is_admin ? "badge-admin" : "badge-user"}">
                            ${user.is_admin ? "üëë Admin" : "üë§ Kullanƒ±cƒ±"}
                        </span>
                    </td>
                    <td data-label="KAYIT">${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="openEditModal('${escapeHtml(user.username)}')" title="D√ºzenle">
                                ‚úèÔ∏è D√ºzenle
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteModal('${escapeHtml(user.username)}')" title="Sil">
                                üóëÔ∏è Sil
                            </button>
                        </div>
                    </td>
                </tr>
            `,
          )
          .join("");
      }

      // ============================================================================
      // Modal Fonksiyonlarƒ±
      // ============================================================================

      function openCreateModal() {
        currentEditUser = null;
        userModalTitle.textContent = "Yeni Kullanƒ±cƒ±";
        userForm.reset();
        document.getElementById("formUsername").disabled = false;
        document.getElementById("passwordGroup").style.display = "block";
        document.getElementById("formPassword").required = true;
        document.getElementById("formPassword").placeholder =
          "≈ûifre (en az 8 karakter)";
        document.getElementById("formError").style.display = "none";
        userModal.classList.add("active");
      }

      function openEditModal(username) {
        const user = users.find((u) => u.username === username);
        if (!user) return;

        currentEditUser = username;
        userModalTitle.textContent = "Kullanƒ±cƒ±yƒ± D√ºzenle";

        document.getElementById("formUsername").value = user.username;
        document.getElementById("formUsername").disabled = true;
        document.getElementById("formEmail").value = user.email || "";
        document.getElementById("formFullName").value = user.full_name || "";
        document.getElementById("formIsAdmin").checked = user.is_admin;
        document.getElementById("passwordGroup").style.display = "block";
        document.getElementById("formPassword").value =
          user._plain_password || "";
        document.getElementById("formPassword").required = false;
        document.getElementById("formPassword").placeholder =
          "Deƒüi≈ütirmek istemiyorsanƒ±z bo≈ü bƒ±rakƒ±n";
        document.getElementById("formError").style.display = "none";

        userModal.classList.add("active");
      }

      function closeUserModal() {
        userModal.classList.remove("active");
        currentEditUser = null;
      }

      function openDeleteModal(username) {
        userToDelete = username;
        deleteDescription.innerHTML = `
                <strong>${escapeHtml(username)}</strong> kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?
                <br><br>
                <span style="color: var(--error);">‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz ve kullanƒ±cƒ±nƒ±n t√ºm sohbet ge√ßmi≈üi silinecektir.</span>
            `;
        deleteModal.classList.add("active");
      }

      function closeDeleteModal() {
        deleteModal.classList.remove("active");
        userToDelete = null;
      }

      // ============================================================================
      // Olay ƒ∞≈üleyicileri (Event Handlers)
      // ============================================================================

      // Yeni Kullanƒ±cƒ± Butonu
      document
        .getElementById("newUserBtn")
        .addEventListener("click", openCreateModal);

      // Uygulamaya D√∂n Butonu
      document.getElementById("backToAppBtn").addEventListener("click", () => {
        window.location.href = "/";
      });

      // Filtre ve Sƒ±ralama Deƒüi≈üiklikleri
      filterAdmin.addEventListener("change", fetchUsers);
      sortBy.addEventListener("change", fetchUsers);
      sortOrder.addEventListener("change", fetchUsers);

      // Kullanƒ±cƒ± Formu G√∂nderimi
      userForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formError = document.getElementById("formError");
        const saveBtn = document.getElementById("saveUserBtn");

        formError.style.display = "none";
        saveBtn.disabled = true;
        saveBtn.textContent = "Kaydediliyor...";

        try {
          if (currentEditUser) {
            // Mevcut kullanƒ±cƒ±yƒ± g√ºncelle
            const userData = {
              email: document.getElementById("formEmail").value || null,
              full_name: document.getElementById("formFullName").value || null,
              is_admin: document.getElementById("formIsAdmin").checked,
              password: document.getElementById("formPassword").value || null,
            };

            await updateUser(currentEditUser, userData);
            showToast("Kullanƒ±cƒ± g√ºncellendi", "success");
          } else {
            // Yeni kullanƒ±cƒ± olu≈ütur
            const userData = {
              username: document.getElementById("formUsername").value,
              password: document.getElementById("formPassword").value,
              email: document.getElementById("formEmail").value || null,
              full_name: document.getElementById("formFullName").value || null,
              is_admin: document.getElementById("formIsAdmin").checked,
            };

            await createUser(userData);
            showToast("Kullanƒ±cƒ± olu≈üturuldu", "success");
          }

          closeUserModal();
          // K√º√ß√ºk bir gecikme ekleyerek backend'in dosyayƒ± yazdƒ±ƒüƒ±ndan emin olalƒ±m
          setTimeout(() => fetchUsers(), 300);
        } catch (error) {
          formError.textContent = error.message;
          formError.style.display = "block";
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "Kaydet";
        }
      });

      // Kullanƒ±cƒ± Modalƒ±nƒ± ƒ∞ptal Et
      document
        .getElementById("cancelUserBtn")
        .addEventListener("click", closeUserModal);

      // Silme Onayƒ±
      document
        .getElementById("confirmDeleteBtn")
        .addEventListener("click", async () => {
          if (!userToDelete) return;

          const confirmBtn = document.getElementById("confirmDeleteBtn");
          confirmBtn.disabled = true;
          confirmBtn.textContent = "Siliniyor...";

          try {
            await deleteUser(userToDelete);
            showToast("Kullanƒ±cƒ± silindi", "success");
            closeDeleteModal();
            // K√º√ß√ºk bir gecikme ekleyerek backend'in dosyayƒ± yazdƒ±ƒüƒ±ndan emin olalƒ±m
            setTimeout(() => fetchUsers(), 300);
          } catch (error) {
            showToast(error.message, "error");
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Sil";
          }
        });

      // Escape tu≈üuna basƒ±ldƒ±ƒüƒ±nda modallarƒ± kapat
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeUserModal();
          closeDeleteModal();
        }
      });

      // Overlay tƒ±klamasƒ±nda modallarƒ± kapat
      userModal.addEventListener("click", (e) => {
        if (e.target === userModal) closeUserModal();
      });

      deleteModal.addEventListener("click", (e) => {
        if (e.target === deleteModal) closeDeleteModal();
      });

      // ============================================================================
      // Ba≈ülatma
      // ============================================================================

      // Sayfa y√ºklendiƒüinde kimlik doƒürulamayƒ± kontrol et
      document.addEventListener("DOMContentLoaded", () => {
        const token = getToken();
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        fetchUsers();
      });
    </script>
  </body>
</html>
